<!DOCTYPE html>
<html lang="en">
<head>
    <title>ASCII Animator</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link type="text/css" rel="stylesheet" href="main.css">
</head>
<body>
    <!-- Modern Left Sidebar UI -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h1>ASCII ANIMATOR</h1>
            <div class="subtitle">3D Models</div>
        </div>
        
        <div class="sidebar-content">
            <!-- Theme & Display Section -->
            <div class="control-section">
                <h3>Display</h3>
                <div class="control-group">
                    <button id="themeToggle" class="btn btn-primary" title="Switch between light and dark themes">
                        <span class="btn-icon">üåì</span>
                        Toggle Theme
                    </button>
                </div>
                <div class="control-group">
                    <button id="helpBtn" class="btn btn-info" title="Show help guide with all controls and features">
                        <span class="btn-icon">‚ùì</span>
                        Help & Controls
                    </button>
                </div>
                <div class="control-group">
                    <label class="slider-label">ASCII Density</label>
                    <input id="densitySlider" type="range" min="0.5" max="2" step="0.1" value="1.5" class="slider" title="Adjust ASCII character density - higher values = more detail but may cause lag">
                    <div class="slider-value" id="densityValue" title="Current ASCII density value - shows how detailed the rendering is">1.5</div>
                </div>
                <div class="control-group">
                    <label class="slider-label">Custom ASCII Characters</label>
                    <input id="customCharsInput" type="text" placeholder="Type custom characters (e.g. HELLO WORLD)" class="text-input" title="Enter custom text to use for ASCII rendering. Your text will be used for bright areas, spaces for dark areas. Try words, names, or short phrases!">
                    <div class="button-row">
                        <button id="applyCharsBtn" class="btn btn-primary btn-small" title="Apply the custom characters to the model">Apply</button>
                        <button id="resetCharsBtn" class="btn btn-secondary btn-small" title="Reset to default ASCII character set">Reset</button>
                    </div>
                </div>
            </div>

            <!-- Model Section -->
            <div class="control-section">
                <h3>Model</h3>
                <div class="control-group">
                    <button id="nextModel" class="btn btn-primary" title="Cycle through available 3D models (Duck ‚Üí Rat ‚Üí Doge ‚Üí Alien)">
                        <span class="btn-icon">üîÑ</span>
                        Next Model
                    </button>
                    <div class="model-info" id="modelInfo" title="Currently selected 3D model - click Next Model to change">Duck</div>
                </div>
                <div class="control-group">
                    <label class="slider-label">Animation Speed</label>
                    <input id="animSpeedSlider" type="range" min="0.1" max="3" step="0.1" value="0.6" class="slider" title="Control animation playback speed - affects walk cycles and movements">
                    <div class="slider-value" id="animSpeedValue" title="Current animation speed multiplier - 1.0 is normal speed">0.6</div>
                </div>
            </div>

            <!-- Camera Section -->
            <div class="control-section">
                <h3>Camera</h3>
                <div class="control-group">
                    <button id="rotationToggle" class="btn btn-secondary" title="Enable or disable automatic camera rotation around the model">
                        <span class="btn-icon">‚ü≤</span>
                        Stop Rotation
                    </button>
                </div>
                <div class="control-group">
                    <label class="slider-label">Rotation Speed</label>
                    <input id="rotSpeedSlider" type="range" min="0" max="2" step="0.1" value="0.3" class="slider" title="Adjust the speed of automatic camera rotation">
                    <div class="slider-value" id="rotSpeedValue" title="Current auto-rotation speed - higher values spin faster">0.3</div>
                </div>
                <div class="control-group">
                    <label class="slider-label">Camera Distance</label>
                    <input id="distanceSlider" type="range" min="250" max="3000" step="50" value="1000" class="slider" title="Set camera distance from model - closer values for detail, farther for full view">
                    <div class="slider-value" id="distanceValue" title="Current camera distance from model in units">1000</div>
                </div>
                <div class="control-group">
                    <button id="resetCamera" class="btn btn-warning" title="Reset all camera settings and sliders to default values">
                        <span class="btn-icon">‚åÇ</span>
                        Reset Camera
                    </button>
                </div>
            </div>

            <!-- Lighting Section -->
            <div class="control-section">
                <h3>Lighting</h3>
                <div class="control-group">
                    <div class="lighting-presets">
                        <button id="presetStudio" class="btn btn-secondary preset-btn" title="Balanced professional lighting setup">Studio</button>
                        <button id="presetDramatic" class="btn btn-secondary preset-btn" title="High contrast dramatic lighting with strong shadows">Dramatic</button>
                        <button id="presetNatural" class="btn btn-secondary preset-btn" title="Soft natural lighting for realistic appearance">Natural</button>
                        <button id="presetMinimal" class="btn btn-secondary preset-btn" title="Minimal lighting setup with reduced complexity">Minimal</button>
                    </div>
                </div>
                <div class="control-group">
                    <label class="slider-label">Front Light Intensity</label>
                    <input id="mainLightSlider" type="range" min="0" max="15" step="0.5" value="10" class="slider" title="SHOULD SEE: Natural directional lighting from FRONT. Creates depth/shadows. At 0=no front light, at 15=bright front illumination. Different from ambient - this creates contrast.">
                    <div class="slider-value" id="mainLightValue" title="Current front light intensity - main illumination strength">10</div>
                </div>
                <div class="control-group">
                    <label class="slider-label">Ambient Light</label>
                    <input id="ambientLightSlider" type="range" min="0" max="2" step="0.05" value="0.1" class="slider" title="SHOULD SEE: UNIFORM brightness everywhere. No shadows/contrast. At 0=deep shadows, at 2=very flat/bright evenly lit. This is base lighting that affects everything equally.">
                    <div class="slider-value" id="ambientLightValue" title="Current ambient light level - base lighting that affects everything equally">0.1</div>
                </div>
                <div class="control-group">
                    <label class="slider-label">Right Light Intensity</label>
                    <input id="redLightSlider" type="range" min="0" max="15" step="0.5" value="10" class="slider" title="SHOULD SEE: Directional lighting from RIGHT SIDE of model. At 0=no right lighting, at 15=strong illumination from right side.">
                    <div class="slider-value" id="redLightValue" title="Current right side light intensity - illumination from the right">10</div>
                </div>
                <div class="control-group">
                    <label class="slider-label">Left Light Intensity</label>
                    <input id="blueLightSlider" type="range" min="0" max="15" step="0.5" value="10" class="slider" title="SHOULD SEE: Directional lighting from LEFT SIDE of model. At 0=no left lighting, at 15=strong illumination from left side.">
                    <div class="slider-value" id="blueLightValue" title="Current left side light intensity - illumination from the left">10</div>
                </div>
                <div class="control-group">
                    <label class="slider-label">Overhead Spotlight Intensity</label>
                    <input id="spotLightSlider" type="range" min="0" max="15" step="0.5" value="3" class="slider" title="SHOULD SEE: Focused bright circle from ABOVE. At 0=no top lighting, at 15=very strong bright circle on top surfaces of model.">
                    <div class="slider-value" id="spotLightValue" title="Current overhead spotlight intensity - focused light from above">3</div>
                </div>
            </div>

            <!-- Export Section -->
            <div class="control-section">
                <h3>Export</h3>
                <div class="control-group">
                    <button id="copyBtn" class="btn btn-success" title="Copy current ASCII art to clipboard for pasting elsewhere">
                        <span class="btn-icon">üìã</span>
                        Copy ASCII
                    </button>
                </div>
                <div class="control-group">
                    <button id="downloadBtn" class="btn btn-success" title="Download ASCII art as a text file to your computer">
                        <span class="btn-icon">üíæ</span>
                        Download
                    </button>
                </div>
                <div class="control-group">
                    <button id="screenshotBtn" class="btn btn-success" title="Take a screenshot of the current ASCII view (requires additional library)">
                        <span class="btn-icon">üì∏</span>
                        Screenshot
                    </button>
                </div>
            </div>

            <!-- File Section -->
            <div class="control-section">
                <h3>File</h3>
                <div class="control-group">
                    <input id="fileInput" type="file" style="display: none" accept=".glb,.gltf">
                    <button id="uploadBtn" class="btn btn-info" onclick="document.getElementById('fileInput').click()" title="Upload your own 3D model file (.glb or .gltf format)">
                        <span class="btn-icon">üìÅ</span>
                        Upload Model
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Canvas Container -->
    <div id="canvasContainer"></div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.178.0/build/three.module.js';
        import { AsciiEffect } from 'https://unpkg.com/three@0.178.0/examples/jsm/effects/AsciiEffect.js?module';
        import { OrbitControls } from 'https://unpkg.com/three@0.178.0/examples/jsm/controls/OrbitControls.js?module';
        import { GLTFLoader } from 'https://unpkg.com/three@0.178.0/examples/jsm/loaders/GLTFLoader.js?module';
        
        let camera, controls, scene, renderer, effect;
        let mixer, eyeModel;
        let canvasContainer;
        let scaleFactor = 1.5; // Higher default ASCII density (1 = original)
        const minScaleFactor = 0.5;
        const maxScaleFactor = 3.0;
        let lastDensityUpdate = 0; // For throttling updates
        const clock = new THREE.Clock();
        
        // Light references for controls
        let lights = {
            main: null,
            ambient: null,
            red: null,
            blue: null,
            spotlight: null,
            directional1: null,
            directional2: null,
            support: [] // Array for support lights
        };
        // Model and animation state - Updated to match animation system
        const modelNames = ['duck', 'rat', 'doge', 'alien'];
        let currentModelIndex = 0;
        let currentModelName = modelNames[currentModelIndex];
        let modelLoadVersion = 0;
        let duckAnimations = { walk: null };
        let ratAnimations = { walkDefault: null, walkStart: null, walkEnd: null, idle: null };
        let dogeAnimations = { sitting: null, playDead: null };
        let alienAnimations = { default: null };
        
        // Global animation system for right-click switching
        let currentAnimations = []; // All available animations for current model
        let currentAnimationIndex = 0;
        let currentPlayingAction = null;
        // Helper to clear rat actions
        function stopAllRatActions() {
            Object.values(ratAnimations).forEach(action => {
                if (action) action.stop();
            });
        }
        
        // Debug function to check all lights in scene
        function debugLights() {
            console.log('üîç LIGHTING DEBUG:');
            console.log('Scene children count:', scene.children.length);
            console.log('Lights object:', lights);
            
            const sceneLights = scene.children.filter(child => 
                child.type === 'PointLight' || 
                child.type === 'AmbientLight' || 
                child.type === 'DirectionalLight' || 
                child.type === 'SpotLight'
            );
            console.log('Lights found in scene:', sceneLights);
            
            if (lights.main) console.log('Main light intensity:', lights.main.intensity);
            if (lights.red) console.log('Red light intensity:', lights.red.intensity);
            if (lights.blue) console.log('Blue light intensity:', lights.blue.intensity);
            if (lights.spotlight) console.log('Spotlight intensity:', lights.spotlight.intensity);
            if (lights.ambient) console.log('Ambient light intensity:', lights.ambient.intensity);
        }
        
        // Function to switch to next animation
        function switchToNextAnimation() {
            if (currentAnimations.length === 0 || !mixer) return;
            
            // Stop current animation
            if (currentPlayingAction) {
                currentPlayingAction.stop();
            }
            
            // Move to next animation
            currentAnimationIndex = (currentAnimationIndex + 1) % currentAnimations.length;
            const nextClip = currentAnimations[currentAnimationIndex];
            
            console.log(`Switching to animation: ${nextClip.name} (${currentAnimationIndex + 1}/${currentAnimations.length})`);
            
            // Play new animation
            currentPlayingAction = mixer.clipAction(nextClip);
            currentPlayingAction.setLoop(THREE.LoopRepeat, Infinity);
            currentPlayingAction.setEffectiveTimeScale(0.6);
            currentPlayingAction.reset().play();
            
            // Show notification
            showCameraMessage(`Animation: ${nextClip.name} (${currentAnimationIndex + 1}/${currentAnimations.length})`);
        }
        let lastPointerOnModel = false;
        
        // New global variable declarations near other globals
        let pointerOnModel = false;
        const pointerSpeedMultiplier = 2; // reduced speed up factor when pointer on model
        let baseRotationSpeed = 0.3; // higher normal auto-rotation speed for more visible difference
        let scrollSpeed = 0; // additional speed modifier from scroll gestures
        let mouseOverModel = false;
        
        // Helper to show camera status messages
        function showCameraMessage(message) {
            // Create a temporary message overlay
            const messageDiv = document.createElement('div');
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.left = '50%';
            messageDiv.style.transform = 'translateX(-50%)';
            messageDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            messageDiv.style.color = 'white';
            messageDiv.style.padding = '10px 20px';
            messageDiv.style.borderRadius = '5px';
            messageDiv.style.fontSize = '14px';
            messageDiv.style.zIndex = '1000';
            messageDiv.style.fontFamily = 'Geist, sans-serif';
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // Remove message after 5 seconds
            setTimeout(() => {
                if (document.body.contains(messageDiv)) {
                    document.body.removeChild(messageDiv);
                }
            }, 5000);
        }
        
        // Helper to apply current scaleFactor
        function updateAsciiScale() {
            if (!effect || !canvasContainer) return;
            const rect = canvasContainer.getBoundingClientRect();
            effect.setSize(rect.width * scaleFactor, rect.height * scaleFactor);
            effect.domElement.style.transform = `translate(-50%, -50%) scale(${1 / scaleFactor})`;
        }

        // Global variables for character management
        let defaultChars = " .'`^\",:;Il!i~+_-?][}{1)(|\\/tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$";
        let currentCustomChars = defaultChars;

        // Function to update ASCII characters
        function updateAsciiCharacters(newChars) {
            console.log('üî§ updateAsciiCharacters called with:', newChars);
            
            if (!newChars || newChars.trim() === '') {
                newChars = defaultChars;
                console.log('Using default chars');
            } else {
                // CRITICAL: Create a proper gradient from user text
                // ASCII needs light-to-dark characters for proper shading
                const userText = newChars.trim();
                
                // Create gradient: spaces (dark) -> user characters (bright)
                // The order matters: darkest to brightest
                newChars = '   ' + userText;  // Start with spaces for shadows/background
                
                // If user text is short, create more gradations
                if (userText.length < 3) {
                    // For very short text, create multiple brightness levels
                    newChars = '    .' + userText + userText.toUpperCase();
                }
                
                // Repeat the gradient to have enough characters
                const targetLength = 50;
                if (newChars.length < targetLength) {
                    const repeats = Math.ceil(targetLength / newChars.length);
                    newChars = newChars.repeat(repeats);
                }
                
                console.log('Custom gradient created:', JSON.stringify(newChars.substring(0, 20)));
            }
            
            currentCustomChars = newChars;
            console.log('Final characters to use:', currentCustomChars.substring(0, 30) + '...');
            
            try {
                // Recreate the ASCII effect with new characters
                const oldEffect = effect;
                effect = new AsciiEffect(renderer, currentCustomChars, { invert: true });
                console.log('‚úÖ New AsciiEffect created');
                
                // Copy styling from old effect
                effect.domElement.style.color = oldEffect.domElement.style.color;
                effect.domElement.style.backgroundColor = oldEffect.domElement.style.backgroundColor;
                effect.domElement.style.fontWeight = oldEffect.domElement.style.fontWeight;
                effect.domElement.style.fontFamily = oldEffect.domElement.style.fontFamily;
                effect.domElement.style.fontSize = oldEffect.domElement.style.fontSize;
                effect.domElement.style.textShadow = oldEffect.domElement.style.textShadow;
                effect.domElement.style.position = oldEffect.domElement.style.position;
                effect.domElement.style.top = oldEffect.domElement.style.top;
                effect.domElement.style.left = oldEffect.domElement.style.left;
                effect.domElement.style.transformOrigin = oldEffect.domElement.style.transformOrigin;
                
                // Replace in DOM
                if (canvasContainer && canvasContainer.contains(oldEffect.domElement)) {
                    canvasContainer.removeChild(oldEffect.domElement);
                    canvasContainer.appendChild(effect.domElement);
                    updateAsciiScale();
                    console.log('‚úÖ DOM updated');
                }
                
                // Update controls to use new effect
                controls = new OrbitControls(camera, effect.domElement);
                controls.autoRotate = true;
                controls.autoRotateSpeed = baseRotationSpeed;
                controls.enableDamping = true;
                controls.enablePan = false;
                controls.enableRotate = true;
                controls.rotateSpeed = 0.8;
                controls.minDistance = 250;
                controls.maxDistance = 3000;
                controls.minPolarAngle = 0;
                controls.maxPolarAngle = Math.PI;
                controls.target.set(0, 0, 0);
                
                console.log('‚úÖ Updated ASCII characters successfully');
            } catch (error) {
                console.error('‚ùå Error updating ASCII characters:', error);
            }
        }

        // Easy customization: Change this number to adjust character density
        // Higher numbers = more characters (more detail)
        // Lower numbers = fewer characters (less detail)
        const baseCharacterDensity = 50000; // Even higher density for more detail

        init();







        function getDistance(p1, p2) {
            const dx = p1.x - p2.x;
            const dy = p1.y - p2.y;
            return Math.hypot(dx, dy);
        }

        function init() {
            // Use full screen dimensions
            const canvasWidth = window.innerWidth;
            const canvasHeight = window.innerHeight;

            camera = new THREE.PerspectiveCamera(70, canvasWidth / canvasHeight, 1, 5000);
            camera.position.set(0, 150, 900);

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0, 0, 0);

            // Main light - NATURAL front lighting from camera direction
            lights.main = new THREE.PointLight(0xffffff, 10.0, 0, 0); // intensity, distance, decay
            lights.main.position.set(0, 150, 800); // Near camera position for natural front lighting
            scene.add(lights.main);
            console.log('‚úÖ Created main light:', lights.main, 'intensity:', lights.main.intensity);
            
            // Ambient light - keep some for base lighting
            lights.ambient = new THREE.AmbientLight(0xffffff, 0.1);
            scene.add(lights.ambient);
            console.log('‚úÖ Created ambient light:', lights.ambient, 'intensity:', lights.ambient.intensity);

            // TEMPORARILY DISABLED: Support lights might be overwhelming other lights
            // const supportLight1 = new THREE.PointLight(0xffffff, 1.0);
            // supportLight1.position.set(-500, -500, -500);
            // lights.support.push(supportLight1);
            // scene.add(supportLight1);

            // const supportLight2 = new THREE.PointLight(0xffffff, 2.0);
            // supportLight2.position.set(0, 300, 200);
            // lights.support.push(supportLight2);
            // scene.add(supportLight2);

            // const supportLight3 = new THREE.PointLight(0xffffff, 1.5);
            // supportLight3.position.set(-300, 200, -200);
            // lights.support.push(supportLight3);
            // scene.add(supportLight3);

            // const supportLight4 = new THREE.PointLight(0xffffff, 1.2);
            // supportLight4.position.set(300, -200, 300);
            // lights.support.push(supportLight4);
            // scene.add(supportLight4);

            // Colored lights - NO DECAY, closer positions
            lights.red = new THREE.PointLight(0xff2222, 10.0, 0, 0); // No distance falloff
            lights.red.position.set(200, 50, 200); // Right side, closer
            scene.add(lights.red);
            console.log('‚úÖ Created red light:', lights.red, 'intensity:', lights.red.intensity);

            lights.blue = new THREE.PointLight(0x2222ff, 10.0, 0, 0); // No distance falloff  
            lights.blue.position.set(-200, 50, 200); // Left side, closer
            scene.add(lights.blue);
            console.log('‚úÖ Created blue light:', lights.blue, 'intensity:', lights.blue.intensity);

            // TEMPORARILY DISABLE directional lights - they were overwhelming the controllable lights
            // lights.directional1 = new THREE.DirectionalLight(0xffffff, 3.0);
            // lights.directional1.position.set(200, 400, 100);
            // lights.directional1.target.position.set(0, 0, 0); // Point at model center
            // scene.add(lights.directional1);
            // scene.add(lights.directional1.target);

            // lights.directional2 = new THREE.DirectionalLight(0xffffff, 2.0);
            // lights.directional2.position.set(-200, 300, -100);
            // lights.directional2.target.position.set(0, 0, 0); // Point at model center
            // scene.add(lights.directional2);
            // scene.add(lights.directional2.target);

            // Spotlight - DIRECTLY ABOVE model pointing down, NO DECAY like other lights
            lights.spotlight = new THREE.SpotLight(0xffffff, 3.0);
            lights.spotlight.position.set(0, 400, 0); // Directly above
            lights.spotlight.target.position.set(0, 0, 0); // Point at model center
            lights.spotlight.angle = Math.PI / 4; // Wider cone
            lights.spotlight.penumbra = 0.2;
            lights.spotlight.decay = 0; // NO DECAY - same as PointLights
            lights.spotlight.distance = 0; // NO DISTANCE LIMIT - same as PointLights
            scene.add(lights.spotlight);
            scene.add(lights.spotlight.target); // Add the target to the scene
            console.log('‚úÖ Created spotlight:', lights.spotlight, 'intensity:', lights.spotlight.intensity);

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(canvasWidth, canvasHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // Use the global defaultChars, sliced for density
            defaultChars = defaultChars.slice(0, baseCharacterDensity);
            currentCustomChars = defaultChars;
            
            // Create ASCII effect - BEFORE loading model
            effect = new AsciiEffect(renderer, currentCustomChars, { invert: true });
            
            // CRITICAL: Ensure AsciiEffect uses our properly configured renderer
            console.log('üîç AsciiEffect created. Internal renderer:', effect.domElement);
            console.log('üîç Main renderer shadow settings:', renderer.shadowMap.enabled, renderer.shadowMap.type);
            
            // Try to access and configure the internal renderer if it exists
            if (effect && effect.domElement && effect.domElement.renderer) {
                const internalRenderer = effect.domElement.renderer;
                console.log('üîç Found internal renderer:', internalRenderer);
                if (internalRenderer.shadowMap) {
                    internalRenderer.shadowMap.enabled = true;
                    internalRenderer.shadowMap.type = THREE.PCFSoftShadowMap;
                    console.log('‚úÖ Configured internal renderer shadows');
                }
            }
            
            renderer.setAnimationLoop(animate);

            loadModel(currentModelName);
            
            // Initialize model info display
            const modelInfo = document.getElementById('modelInfo');
            if (modelInfo) {
                modelInfo.textContent = currentModelName.charAt(0).toUpperCase() + currentModelName.slice(1);
            }
            effect.domElement.style.color = 'black'; // Black text in light mode
            effect.domElement.style.backgroundColor = 'white';
            effect.domElement.style.fontWeight = '900';
            effect.domElement.style.fontFamily = 'Geist, monospace';
            effect.domElement.style.fontSize = '20px'; // Slightly smaller font size for tighter density
            effect.domElement.style.textShadow = 'none';
            effect.domElement.style.position = 'absolute';
            effect.domElement.style.top = '50%';
            effect.domElement.style.left = '50%';
            effect.domElement.style.transformOrigin = 'center center';
            // initial translate to centre combined with scale applied later

            canvasContainer = document.getElementById('canvasContainer');
            canvasContainer.style.width = canvasWidth + 'px';
            canvasContainer.style.height = canvasHeight + 'px';
            
            canvasContainer.appendChild(effect.domElement);
            updateAsciiScale();

            
            // Add mouse controls for PC users
            function isMouseOverModel(event) {
                const rect = canvasContainer.getBoundingClientRect();
                const mouseX = event.clientX - rect.left;
                const mouseY = event.clientY - rect.top;
                
                // Check if mouse is near center (where model is)
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const dx = mouseX - centerX;
                const dy = mouseY - centerY;
                const dist = Math.hypot(dx, dy);
                const threshold = Math.min(rect.width, rect.height) * 0.2;
                
                return dist < threshold;
            }
            
            
            canvasContainer.addEventListener('contextmenu', (event) => {
                // Right click for animation switching
                event.preventDefault(); // Prevent context menu
                
                // Switch to next animation
                switchToNextAnimation();
            });

            controls = new OrbitControls(camera, effect.domElement);
            controls.autoRotate = true; // enable continuous rotation
            controls.autoRotateSpeed = baseRotationSpeed;
            controls.enableDamping = true;
            controls.enablePan = false;
            controls.enableRotate = true;
            controls.rotateSpeed = 0.8;
            controls.minDistance = 250;
            controls.maxDistance = 3000;
            controls.minPolarAngle = 0; // Allow full rotation from top view
            controls.maxPolarAngle = Math.PI; // Allow full rotation to bottom view
            controls.target.set(0, 0, 0);
            window.addEventListener('resize', onWindowResize);
            
            // TEMPORARY TEST: Add keyboard listener for testing WebGL vs ASCII rendering
            window.testWebGLMode = false;
            document.addEventListener('keydown', function(event) {
                if (event.key === 't' || event.key === 'T') {
                    window.testWebGLMode = !window.testWebGLMode;
                    console.log('Rendering mode:', window.testWebGLMode ? 'WebGL (normal)' : 'ASCII');
                    
                    // Show/hide canvas container appropriately
                    if (window.testWebGLMode) {
                        // For WebGL mode, append the renderer's canvas
                        canvasContainer.innerHTML = '';
                        canvasContainer.appendChild(renderer.domElement);
                    } else {
                        // For ASCII mode, show the ASCII effect
                        canvasContainer.innerHTML = '';
                        canvasContainer.appendChild(effect.domElement);
                    }
                } else if (event.key === 'l' || event.key === 'L') {
                    // Press 'L' to debug lights
                    debugLights();
                } else if (event.key === 'x' || event.key === 'X') {
                    // Press 'X' to manually test light changes
                    console.log('üß™ MANUAL LIGHT TEST');
                    if (lights.main) {
                        console.log('Setting main light to 0, then 5');
                        lights.main.intensity = 0;
                        setTimeout(() => {
                            lights.main.intensity = 5;
                            console.log('Main light now at:', lights.main.intensity);
                        }, 1000);
                    }
                }
            });
            
            toggleTheme(); // Set initial theme to dark
        }

        function switchModel(offset) {
            currentModelIndex = (currentModelIndex + offset + modelNames.length) % modelNames.length;
            currentModelName = modelNames[currentModelIndex];
            loadModel(currentModelName);
            // Update the model info in the new UI
            const modelInfo = document.getElementById('modelInfo');
            if (modelInfo) {
                modelInfo.textContent = currentModelName.charAt(0).toUpperCase() + currentModelName.slice(1);
            }
        }

        function loadModel(name) {
            if (eyeModel) {
                scene.remove(eyeModel);
                eyeModel = null;
                mixer = null;
            }
            const thisLoadVersion = ++modelLoadVersion;
            const loader = new GLTFLoader();

            const modelConfig = {
                duck: { path: './2.glb', scaleMultiplier: 5.0 },  // 2.glb has the duck model
                rat: { path: './3.glb', scaleMultiplier: 8.0 },   // 3.glb has the rat  
                doge: { path: './1.glb', scaleMultiplier: 6.0 },  // 1.glb has the dog
                alien: { path: './alien.glb', scaleMultiplier: 6.0 }
            };

            const config = modelConfig[name] || modelConfig.duck;
            const modelPath = config.path;
            const modelScaleMultiplier = config.scaleMultiplier;

            const isDuck = name === 'duck';
            const isRat = name === 'rat';
            const isDoge = name === 'doge';
            const attribution = isDuck ? '<!-- "Model_Walk (Free)" (https://skfb.ly/owq7o) by Nyilonelycompany is licensed under CC BY 4.0 -->'
                                : isRat ? '<!-- "Black Rat ( Free download )" (https://skfb.ly/p9TYP) by Nestaeric is licensed under Creative Commons Attribution (http://creativecommons.org/licenses/by/4.0/). -->'
                                : isDoge ? '<!-- "Animated Dog, Shiba Inu" (https://skfb.ly/6SrJO) by quander is licensed under Creative Commons Attribution (http://creativecommons.org/licenses/by/4.0/). -->'
                                : '<!-- Default model -->';
            
            loader.load(modelPath, (gltf) => {
                if (thisLoadVersion !== modelLoadVersion) return; // Skip if a newer load has occurred
                
                // DEBUG: Log animation info
                console.log(`Loading ${name} model:`, modelPath);
                console.log(`Found ${gltf.animations.length} animations:`, gltf.animations.map(a => a.name));
                
                eyeModel = gltf.scene;
                const box = new THREE.Box3().setFromObject(eyeModel);
                const size = new THREE.Vector3();
                const center = new THREE.Vector3();
                box.getSize(size);
                box.getCenter(center);
                const maxDim = Math.max(size.x, size.y, size.z);
                const desiredSize = 150;
                const scale = desiredSize / maxDim;
                eyeModel.scale.setScalar(scale * modelScaleMultiplier);
                eyeModel.position.set(
                    -center.x * scale * modelScaleMultiplier,
                    -center.y * scale * modelScaleMultiplier,
                    -center.z * scale * modelScaleMultiplier
                );
                eyeModel.originalPosition = eyeModel.position.clone();
                eyeModel.traverse((child) => {
                    if (child.isMesh) {
                        if (child.material) {
                            console.log('üîç MATERIAL DEBUG - Type:', child.material.type, 'Material:', child.material);
                            
                            // CRITICAL: Force ALL materials to respond to lighting
                            if (child.material.type === 'MeshStandardMaterial' || child.material.type === 'MeshPhysicalMaterial') {
                                child.material.metalness = 0.1;
                                child.material.roughness = 0.8;
                                console.log('‚úÖ Configured PBR material for lighting');
                            } else if (child.material.type === 'MeshBasicMaterial') {
                                // MeshBasicMaterial doesn't respond to lights - convert to MeshLambertMaterial
                                console.log('üîÑ Converting MeshBasicMaterial to MeshLambertMaterial for lighting');
                                const oldMaterial = child.material;
                                child.material = new THREE.MeshLambertMaterial({
                                    color: oldMaterial.color,
                                    map: oldMaterial.map,
                                    transparent: oldMaterial.transparent,
                                    opacity: oldMaterial.opacity
                                });
                                console.log('‚úÖ Material converted to Lambert for lighting');
                            } else if (child.material.type === 'MeshLambertMaterial') {
                                console.log('‚úÖ Lambert material already supports lighting');
                            } else {
                                // For any other material type, try to convert to Lambert as well
                                console.log('üîÑ Converting unknown material type to Lambert for lighting');
                                const oldMaterial = child.material;
                                child.material = new THREE.MeshLambertMaterial({
                                    color: oldMaterial.color || new THREE.Color(0xffffff),
                                    map: oldMaterial.map,
                                    transparent: oldMaterial.transparent || false,
                                    opacity: oldMaterial.opacity || 1.0
                                });
                                console.log('‚úÖ Unknown material converted to Lambert');
                            }
                            child.material.needsUpdate = true;
                        }
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                scene.add(eyeModel);
                camera.lookAt(0, 0, 0);
                if (gltf.animations && gltf.animations.length) {
                    mixer = new THREE.AnimationMixer(eyeModel);
                    
                    // Initialize animation switching system
                    currentAnimations = [...gltf.animations]; // Copy all animations
                    currentAnimationIndex = 0;
                    console.log(`Available animations for ${name}:`, currentAnimations.map(a => a.name));
                    // Start with model-specific default animation or first available
                    if (currentAnimations.length > 0) {
                        let defaultClip = currentAnimations[0]; // Fallback to first animation
                        let defaultIndex = 0;
                        
                        // Set specific default animations for certain models
                        if (name === 'rat') {
                            const ratWalkClip = currentAnimations.find(clip => clip.name === 'Mammals|walk_A1');
                            if (ratWalkClip) {
                                defaultClip = ratWalkClip;
                                defaultIndex = currentAnimations.indexOf(ratWalkClip);
                                console.log(`${name}: Using preferred animation: ${defaultClip.name}`);
                            }
                        } else if (name === 'doge') {
                            const dogeShakeClip = currentAnimations.find(clip => clip.name === '0|shake_0');
                            if (dogeShakeClip) {
                                defaultClip = dogeShakeClip;
                                defaultIndex = currentAnimations.indexOf(dogeShakeClip);
                                console.log(`${name}: Using preferred animation: ${defaultClip.name}`);
                            }
                        }
                        
                        currentAnimationIndex = defaultIndex;
                        currentPlayingAction = mixer.clipAction(defaultClip);
                        currentPlayingAction.setLoop(THREE.LoopRepeat, Infinity);
                        currentPlayingAction.setEffectiveTimeScale(0.6);
                        currentPlayingAction.play();
                        console.log(`${name}: Playing animation: ${defaultClip.name} (${defaultIndex + 1}/${currentAnimations.length})`);
                        console.log(`${name}: Right-click to cycle through ${currentAnimations.length} animations`);
                    } else {
                        console.log(`${name}: No animations found in this model`);
                    }
                }
            }, undefined, (err) => console.error(`${name} GLB load error:`, err));
        }

        function onWindowResize() {
            // Use full screen dimensions
            const newWidth = window.innerWidth;
            const newHeight = window.innerHeight;
            
            camera.aspect = newWidth / newHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(newWidth, newHeight);
            if (canvasContainer) {
                canvasContainer.style.width = newWidth + 'px';
                canvasContainer.style.height = newHeight + 'px';
            }
            updateAsciiScale();
        }

        function animate() {
            let delta = clock.getDelta();
            delta = Math.min(delta, 0.033);
            if (mixer) mixer.update(delta);

            
            // Adjust animation speed based on pointer proximity
            if (mixer) {
                if (currentModelName === 'duck') {
                    const speed = pointerOnModel ? pointerSpeedMultiplier : 0.3; // Slower default speed
                    if (duckAnimations.walk) duckAnimations.walk.setEffectiveTimeScale(speed);
                }
                // mixer.update(delta); // This is a duplicate call, remove it
            }

            controls.update();
            
            // TEMPORARY TEST: Press 'T' to toggle between ASCII and normal WebGL rendering
            if (window.testWebGLMode) {
                renderer.render(scene, camera);
            } else {
                // Ensure the AsciiEffect's internal renderer matches our main renderer settings
                if (effect.domElement && effect.domElement._renderer) {
                    // Copy renderer settings to ASCII effect renderer if possible
                    const asciiRenderer = effect.domElement._renderer;
                    if (asciiRenderer && asciiRenderer !== renderer) {
                        // Try to sync lighting settings
                        console.log('üîç ASCII renderer differs from main renderer');
                    }
                }
                effect.render(scene, camera);
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.contains('dark');
            
            if (isDark) {
                // Switch to light theme
                document.body.classList.remove('dark');
                effect.domElement.style.color = 'black';
                effect.domElement.style.backgroundColor = 'white';
            } else {
                // Switch to dark theme
                document.body.classList.add('dark');
                effect.domElement.style.color = 'white';
                effect.domElement.style.backgroundColor = 'black';
            }
        }

        function ratPointerEnter() {
            if (!ratAnimations.walkEnd) return;
            stopAllRatActions();
            const endAction = ratAnimations.walkEnd;
            const idleAction = ratAnimations.idle;
            endAction.reset().play();
            const duration = endAction.getClip().duration * 1000;
            // After walkEnd finishes, play idle looping as long as pointer still on
            setTimeout(() => {
                if (pointerOnModel && currentModelName === 'rat' && idleAction) {
                    stopAllRatActions();
                    idleAction.reset().play();
                }
            }, duration + 50);
        }

        function ratPointerLeave() {
            if (!ratAnimations.walkStart) {
                // Fallback to default walk directly
                if (ratAnimations.walkDefault) {
                    stopAllRatActions();
                    ratAnimations.walkDefault.reset().play();
                }
                return;
            }
            stopAllRatActions();
            const startAction = ratAnimations.walkStart;
            const walkDefaultAction = ratAnimations.walkDefault;
            startAction.reset().play();
            const duration = startAction.getClip().duration * 1000;
            setTimeout(() => {
                if (!pointerOnModel && currentModelName === 'rat' && walkDefaultAction) {
                    stopAllRatActions();
                    walkDefaultAction.reset().play();
                }
            }, duration + 50);
        }

        // Lighting control functions
        function setLightingPreset(preset) {
            // Remove active class from all preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            
            switch(preset) {
                case 'studio':
                    // Balanced professional lighting - Front key light + rim lights + moderate fill
                    lights.main.intensity = 12.0;      // Strong front key light
                    lights.ambient.intensity = 0.3;    // Moderate fill to reduce harsh shadows
                    lights.red.intensity = 4.0;        // Right rim light for separation
                    lights.blue.intensity = 4.0;       // Left rim light for separation  
                    lights.spotlight.intensity = 8.0;  // Top light for dimension
                    document.getElementById('presetStudio').classList.add('active');
                    break;
                    
                case 'dramatic':
                    // High contrast dramatic lighting - Strong directional, minimal fill
                    lights.main.intensity = 15.0;      // Very strong front light
                    lights.ambient.intensity = 0.05;   // Minimal fill for deep shadows
                    lights.red.intensity = 8.0;        // Strong right accent
                    lights.blue.intensity = 2.0;       // Subtle left fill
                    lights.spotlight.intensity = 12.0; // Strong top drama
                    document.getElementById('presetDramatic').classList.add('active');
                    break;
                    
                case 'natural':
                    // Soft natural lighting - Gentle, even illumination
                    lights.main.intensity = 8.0;       // Moderate front light
                    lights.ambient.intensity = 0.6;    // High fill for soft look
                    lights.red.intensity = 2.0;        // Gentle right side
                    lights.blue.intensity = 2.0;       // Gentle left side
                    lights.spotlight.intensity = 4.0;  // Soft top light
                    document.getElementById('presetNatural').classList.add('active');
                    break;
                    
                case 'minimal':
                    // Minimal lighting setup - Simple front + ambient only
                    lights.main.intensity = 10.0;      // Clean front light
                    lights.ambient.intensity = 0.2;    // Basic fill
                    lights.red.intensity = 0.0;        // No side lights
                    lights.blue.intensity = 0.0;       // No side lights  
                    lights.spotlight.intensity = 0.0;  // No top light
                    document.getElementById('presetMinimal').classList.add('active');
                    break;
                    
                default:
                    // Current/default settings
                    lights.main.intensity = 2.5;
                    lights.ambient.intensity = 0.1;
                    lights.red.intensity = 0.8;
                    lights.blue.intensity = 0.8;
                    lights.spotlight.intensity = 2.5;
                    // lights.directional1.intensity = 3.0; // DISABLED
                    // lights.directional2.intensity = 2.0; // DISABLED
            }
            
            // Update UI sliders to match preset values
            updateLightingSliders();
        }
        
        function updateLightingSliders() {
            // Update slider values and displays
            const mainSlider = document.getElementById('mainLightSlider');
            const mainValue = document.getElementById('mainLightValue');
            const ambientSlider = document.getElementById('ambientLightSlider');
            const ambientValue = document.getElementById('ambientLightValue');
            const redSlider = document.getElementById('redLightSlider');
            const redValue = document.getElementById('redLightValue');
            const blueSlider = document.getElementById('blueLightSlider');
            const blueValue = document.getElementById('blueLightValue');
            const spotSlider = document.getElementById('spotLightSlider');
            const spotValue = document.getElementById('spotLightValue');
            
            if (mainSlider && lights.main) {
                mainSlider.value = lights.main.intensity;
                mainValue.textContent = lights.main.intensity.toFixed(1);
            }
            if (ambientSlider && lights.ambient) {
                ambientSlider.value = lights.ambient.intensity;
                ambientValue.textContent = lights.ambient.intensity.toFixed(2);
            }
            if (redSlider && lights.red) {
                redSlider.value = lights.red.intensity;
                redValue.textContent = lights.red.intensity.toFixed(1);
            }
            if (blueSlider && lights.blue) {
                blueSlider.value = lights.blue.intensity;
                blueValue.textContent = lights.blue.intensity.toFixed(1);
            }
            if (spotSlider && lights.spotlight) {
                spotSlider.value = lights.spotlight.intensity;
                spotValue.textContent = lights.spotlight.intensity.toFixed(1);
            }
        }

        // Event handlers for new UI controls
        document.addEventListener('DOMContentLoaded', function() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Help button
            document.getElementById('helpBtn').addEventListener('click', showHelpModal);

            // ASCII Density slider
            const densitySlider = document.getElementById('densitySlider');
            const densityValue = document.getElementById('densityValue');
            // Density update function
            function updateDensity() {
                scaleFactor = parseFloat(densitySlider.value);
                updateAsciiScale();
                densityValue.textContent = densitySlider.value;
            }
            
            // Add multiple event listeners for better responsiveness
            densitySlider.addEventListener('input', updateDensity);
            densitySlider.addEventListener('change', updateDensity);
            densitySlider.addEventListener('mousemove', function(e) {
                if (e.buttons === 1) { // Left mouse button is pressed
                    updateDensity();
                }
            });

            // Next model
            document.getElementById('nextModel').addEventListener('click', function() {
                switchModel(1);
            });

            // Animation Speed slider
            const animSpeedSlider = document.getElementById('animSpeedSlider');
            const animSpeedValue = document.getElementById('animSpeedValue');
            // Animation speed update function
            function updateAnimationSpeed() {
                const speed = parseFloat(animSpeedSlider.value);
                animSpeedValue.textContent = speed.toFixed(1);
                
                // Update current playing animation speed
                if (currentPlayingAction) {
                    currentPlayingAction.setEffectiveTimeScale(speed);
                }
            }
            
            // Add multiple event listeners for better responsiveness
            animSpeedSlider.addEventListener('input', updateAnimationSpeed);
            animSpeedSlider.addEventListener('change', updateAnimationSpeed);
            animSpeedSlider.addEventListener('mousemove', function(e) {
                if (e.buttons === 1) { // Left mouse button is pressed
                    updateAnimationSpeed();
                }
            });

            // Rotation toggle
            document.getElementById('rotationToggle').addEventListener('click', function() {
                if (controls) {
                    controls.autoRotate = !controls.autoRotate;
                    this.innerHTML = controls.autoRotate ? 
                        '<span class="btn-icon">‚è∏</span>Stop Rotation' : 
                        '<span class="btn-icon">‚ü≤</span>Start Rotation';
                }
            });

            // Rotation Speed slider
            const rotSpeedSlider = document.getElementById('rotSpeedSlider');
            const rotSpeedValue = document.getElementById('rotSpeedValue');
            rotSpeedSlider.addEventListener('input', function() {
                baseRotationSpeed = parseFloat(this.value);
                rotSpeedValue.textContent = this.value;
                if (controls) {
                    controls.autoRotateSpeed = baseRotationSpeed;
                }
            });

            // Camera Distance slider
            const distanceSlider = document.getElementById('distanceSlider');
            const distanceValue = document.getElementById('distanceValue');
            distanceSlider.addEventListener('input', function() {
                const distance = parseFloat(this.value);
                distanceValue.textContent = this.value;
                if (camera && controls) {
                    const direction = camera.position.clone().normalize();
                    camera.position.copy(direction.multiplyScalar(distance));
                    controls.update();
                }
            });

            // Reset Camera
            document.getElementById('resetCamera').addEventListener('click', function() {
                if (controls) {
                    controls.reset();
                    scaleFactor = 1.5;
                    updateAsciiScale();
                    
                    // Reset all sliders to default values
                    densitySlider.value = 1.5;
                    densityValue.textContent = '1.5';
                    rotSpeedSlider.value = baseRotationSpeed;
                    rotSpeedValue.textContent = baseRotationSpeed;
                    distanceSlider.value = 1000;
                    distanceValue.textContent = '1000';
                    animSpeedSlider.value = 0.6;
                    animSpeedValue.textContent = '0.6';
                    
                    // Reset lighting to default
                    setLightingPreset('default');
                }
            });

            // Lighting preset buttons
            document.getElementById('presetStudio').addEventListener('click', () => setLightingPreset('studio'));
            document.getElementById('presetDramatic').addEventListener('click', () => setLightingPreset('dramatic'));
            document.getElementById('presetNatural').addEventListener('click', () => setLightingPreset('natural'));
            document.getElementById('presetMinimal').addEventListener('click', () => setLightingPreset('minimal'));

            // Lighting sliders
            const mainLightSlider = document.getElementById('mainLightSlider');
            const mainLightValue = document.getElementById('mainLightValue');
            mainLightSlider.addEventListener('input', function() {
                console.log('üî• MAIN LIGHT SLIDER EVENT FIRED!');
                const intensity = parseFloat(this.value);
                mainLightValue.textContent = intensity.toFixed(1);
                console.log('Main light slider VALUE:', intensity, 'lights.main exists:', !!lights.main);
                if (lights.main) {
                    console.log('BEFORE: Main light intensity was:', lights.main.intensity);
                    lights.main.intensity = intensity;
                    console.log('AFTER: Set main light intensity to:', lights.main.intensity);
                    console.log('Light object:', lights.main);
                } else {
                    console.error('‚ùå lights.main is null/undefined!');
                    debugLights();
                }
                // Clear preset selection when manually adjusting
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            });

            const ambientLightSlider = document.getElementById('ambientLightSlider');
            const ambientLightValue = document.getElementById('ambientLightValue');
            ambientLightSlider.addEventListener('input', function() {
                const intensity = parseFloat(this.value);
                ambientLightValue.textContent = intensity.toFixed(2);
                if (lights.ambient) {
                    lights.ambient.intensity = intensity;
                }
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            });

            const redLightSlider = document.getElementById('redLightSlider');
            const redLightValue = document.getElementById('redLightValue');
            redLightSlider.addEventListener('input', function() {
                console.log('üî• RED LIGHT SLIDER EVENT FIRED!');
                const intensity = parseFloat(this.value);
                redLightValue.textContent = intensity.toFixed(1);
                console.log('Red light slider VALUE:', intensity, 'lights.red exists:', !!lights.red);
                if (lights.red) {
                    console.log('BEFORE: Red light intensity was:', lights.red.intensity);
                    lights.red.intensity = intensity;
                    console.log('AFTER: Set red light intensity to:', lights.red.intensity);
                }
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            });

            const blueLightSlider = document.getElementById('blueLightSlider');
            const blueLightValue = document.getElementById('blueLightValue');
            blueLightSlider.addEventListener('input', function() {
                const intensity = parseFloat(this.value);
                blueLightValue.textContent = intensity.toFixed(1);
                console.log('Blue light slider:', intensity, 'lights.blue exists:', !!lights.blue);
                if (lights.blue) {
                    lights.blue.intensity = intensity;
                    console.log('Set blue light intensity to:', lights.blue.intensity);
                }
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            });

            const spotLightSlider = document.getElementById('spotLightSlider');
            const spotLightValue = document.getElementById('spotLightValue');
            spotLightSlider.addEventListener('input', function() {
                const intensity = parseFloat(this.value);
                spotLightValue.textContent = intensity.toFixed(1);
                console.log('Spotlight slider:', intensity, 'lights.spotlight exists:', !!lights.spotlight);
                if (lights.spotlight) {
                    lights.spotlight.intensity = intensity;
                    console.log('Set spotlight intensity to:', lights.spotlight.intensity);
                }
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            });

            // Export controls
            document.getElementById('copyBtn').addEventListener('click', function() {
                if (effect && effect.domElement) {
                    const text = effect.domElement.textContent;
                    navigator.clipboard.writeText(text).then(() => {
                        showNotification('ASCII art copied to clipboard!', 'success');
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                        showNotification('Failed to copy to clipboard', 'error');
                    });
                }
            });

            document.getElementById('downloadBtn').addEventListener('click', function() {
                if (effect && effect.domElement) {
                    const text = effect.domElement.textContent;
                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ascii-art-${currentModelName}-${Date.now()}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showNotification('ASCII art downloaded!', 'success');
                }
            });

            document.getElementById('screenshotBtn').addEventListener('click', function() {
                if (effect && effect.domElement) {
                    // Simple fallback since html2canvas is not included
                    showNotification('Screenshot feature requires html2canvas library', 'info');
                    console.log('Screenshot attempted for current view');
                }
            });

            // File upload
            document.getElementById('fileInput').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    showNotification(`Selected file: ${file.name}`, 'info');
                    // File upload functionality would go here
                    console.log('File selected:', file.name);
                }
            });
            
            // Custom ASCII Characters input
            const customCharsInput = document.getElementById('customCharsInput');
            const applyCharsBtn = document.getElementById('applyCharsBtn');
            const resetCharsBtn = document.getElementById('resetCharsBtn');
            
            // Apply custom characters when Apply button is clicked
            applyCharsBtn.addEventListener('click', function() {
                const customText = customCharsInput.value.trim();
                console.log('üî§ Applying custom characters:', customText || '(using default)');
                updateAsciiCharacters(customText);
            });
            
            // Also apply when Enter key is pressed in the input
            customCharsInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const customText = this.value.trim();
                    console.log('üî§ Applying custom characters (Enter):', customText || '(using default)');
                    updateAsciiCharacters(customText);
                }
            });
            
            // Reset to default characters
            resetCharsBtn.addEventListener('click', function() {
                customCharsInput.value = '';
                updateAsciiCharacters('');
                console.log('üîÑ Reset to default ASCII characters');
            });

            // Initialize lighting UI with current values
            updateLightingSliders();
        });

        // Help modal function
        function showHelpModal() {
            const helpContent = `
                <div style="font-family: 'Geist', sans-serif; line-height: 1.6; color: #333;">
                    <h2 style="margin-top: 0; color: #2d3748; font-size: 1.8em; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;">ASCII Animator - Complete Guide</h2>
                    
                    <h3 style="color: #4a5568; margin: 25px 0 12px 0; font-size: 1.3em;">üñ±Ô∏è Mouse & Navigation Controls</h3>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                            <li style="margin-bottom: 8px;"><strong>Left Click + Drag:</strong> Rotate camera around the 3D model - explore from every angle</li>
                            <li style="margin-bottom: 8px;"><strong>Right Click:</strong> Cycle through model animations (when clicked over model area)</li>
                            <li style="margin-bottom: 8px;"><strong>Scroll Wheel:</strong> Zoom in/out to see fine details or get the full view</li>
                            <li style="margin-bottom: 8px;"><strong>Middle Click + Drag:</strong> Pan the view around (if enabled)</li>
                        </ul>
                    </div>
                    
                    <h3 style="color: #4a5568; margin: 25px 0 12px 0; font-size: 1.3em;">üé® Display & Theme</h3>
                    <div style="background: #f0fff4; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                            <li style="margin-bottom: 8px;"><strong>Toggle Theme:</strong> Switch between dark mode (white text on black) and light mode (black text on white)</li>
                            <li style="margin-bottom: 8px;"><strong>ASCII Density:</strong> Adjust detail level from 0.5 (less detail, faster) to 2.0 (more detail, may lag)</li>
                            <li style="margin-bottom: 8px;"><strong>Custom ASCII Characters:</strong> Enter your own text (like "HELLO WORLD") to use as ASCII art characters instead of default symbols</li>
                        </ul>
                    </div>
                    
                    <h3 style="color: #4a5568; margin: 25px 0 12px 0; font-size: 1.3em;">üèóÔ∏è 3D Models & Animation</h3>
                    <div style="background: #fff5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                            <li style="margin-bottom: 8px;"><strong>Next Model:</strong> Cycle through available 3D models (Duck ‚Üí Rat ‚Üí Doge ‚Üí Alien)</li>
                            <li style="margin-bottom: 8px;"><strong>Animation Speed:</strong> Control how fast animations play (0.1 = very slow, 3.0 = very fast)</li>
                            <li style="margin-bottom: 8px;"><strong>Upload Model:</strong> Load your own .glb or .gltf 3D model files</li>
                        </ul>
                        <div style="margin-top: 12px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px; border-left: 4px solid #e53e3e;">
                            <strong>Model Animations:</strong><br>
                            ‚Ä¢ <strong>Duck:</strong> Walking animation<br>
                            ‚Ä¢ <strong>Rat:</strong> Multiple walking animations and idle poses<br>
                            ‚Ä¢ <strong>Doge:</strong> Sitting, shaking, and play animations<br>
                            ‚Ä¢ <strong>Alien:</strong> Default pose animation
                        </div>
                    </div>
                    
                    <h3 style="color: #4a5568; margin: 25px 0 12px 0; font-size: 1.3em;">üì∑ Camera Controls</h3>
                    <div style="background: #fef5e7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                            <li style="margin-bottom: 8px;"><strong>Auto-Rotation:</strong> Enable/disable automatic spinning of the camera around the model</li>
                            <li style="margin-bottom: 8px;"><strong>Rotation Speed:</strong> How fast the auto-rotation spins (0 = stopped, 2 = very fast)</li>
                            <li style="margin-bottom: 8px;"><strong>Camera Distance:</strong> How far the camera is from the model (250 = very close, 3000 = far away)</li>
                            <li style="margin-bottom: 8px;"><strong>Reset Camera:</strong> Return all camera settings and sliders to their default values</li>
                        </ul>
                    </div>
                    
                    <h3 style="color: #4a5568; margin: 25px 0 12px 0; font-size: 1.3em;">üí° Lighting System</h3>
                    <div style="background: #edf2f7; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="margin-bottom: 15px;">
                            <strong>Quick Presets:</strong><br>
                            ‚Ä¢ <strong>Studio:</strong> Professional balanced lighting<br>
                            ‚Ä¢ <strong>Dramatic:</strong> High contrast with strong shadows<br>
                            ‚Ä¢ <strong>Natural:</strong> Soft, realistic lighting<br>
                            ‚Ä¢ <strong>Minimal:</strong> Simple front lighting only
                        </div>
                        <div style="margin-top: 12px;">
                            <strong>Individual Light Controls:</strong><br>
                            ‚Ä¢ <strong>Front Light:</strong> Main illumination from camera direction (0-15)<br>
                            ‚Ä¢ <strong>Ambient Light:</strong> Uniform background lighting that reduces shadows (0-2)<br>
                            ‚Ä¢ <strong>Right Light:</strong> Side lighting from the right (0-15)<br>
                            ‚Ä¢ <strong>Left Light:</strong> Side lighting from the left (0-15)<br>
                            ‚Ä¢ <strong>Overhead Spotlight:</strong> Focused light from above creating dramatic top-lighting (0-15)
                        </div>
                    </div>
                    
                    <h3 style="color: #4a5568; margin: 25px 0 12px 0; font-size: 1.3em;">üì§ Export & Sharing</h3>
                    <div style="background: #f0f4ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                            <li style="margin-bottom: 8px;"><strong>Copy ASCII:</strong> Copy the current ASCII art to your clipboard for pasting in messages, documents, etc.</li>
                            <li style="margin-bottom: 8px;"><strong>Download:</strong> Save the ASCII art as a .txt file to your computer</li>
                            <li style="margin-bottom: 8px;"><strong>Screenshot:</strong> Capture an image of the current view (requires additional library)</li>
                        </ul>
                    </div>
                    
                    <h3 style="color: #4a5568; margin: 25px 0 12px 0; font-size: 1.3em;">‚å®Ô∏è Keyboard Shortcuts (Hidden Features)</h3>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                            <li style="margin-bottom: 8px;"><strong>T key:</strong> Toggle between ASCII mode and normal 3D rendering (for debugging)</li>
                            <li style="margin-bottom: 8px;"><strong>L key:</strong> Show lighting debug information in browser console</li>
                            <li style="margin-bottom: 8px;"><strong>X key:</strong> Test light intensity changes</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; text-align: center;">
                        <h4 style="margin-top: 0; font-size: 1.2em;">üí° Pro Tips</h4>
                        <p style="margin: 10px 0; font-size: 0.95em;">‚Ä¢ Right-click over the model to cycle through different animations</p>
                        <p style="margin: 10px 0; font-size: 0.95em;">‚Ä¢ Try typing your name in Custom ASCII Characters for personalized art</p>
                        <p style="margin: 10px 0; font-size: 0.95em;">‚Ä¢ Use the Dramatic lighting preset for the most striking ASCII effects</p>
                        <p style="margin: 10px 0 0 0; font-size: 0.95em;">‚Ä¢ Lower ASCII Density if the animation feels sluggish on slower devices</p>
                    </div>
                </div>
            `;
            
            showModal('Help & Controls', helpContent);
        }

        // Generic modal function
        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                font-family: 'Geist', sans-serif;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 12px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                position: relative;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '‚úï';
            closeBtn.style.cssText = `
                position: absolute;
                top: 15px;
                right: 20px;
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
                padding: 5px;
                line-height: 1;
            `;
            
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            modalContent.innerHTML = content;
            modalContent.appendChild(closeBtn);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // Helper function to show notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-family: 'Geist', sans-serif;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                transition: all 0.3s ease;
                transform: translateX(100%);
            `;
            
            const colors = {
                success: 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)',
                error: 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)',
                info: 'linear-gradient(135deg, #4299e1 0%, #3182ce 100%)',
                warning: 'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)'
            };
            
            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>